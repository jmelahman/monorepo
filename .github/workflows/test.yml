name: Tests

on:
  push:
    branches:
      - master
  pull_request:

permissions: {}

jobs:
  generic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: astral-sh/setup-uv@d9e0f98d3fc6adb07d1e3d37f3043649ddad06a1 # ratchet:astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: Run check-symlinks
        run: uvx check-symlinks
  golang:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # ratchet:actions/setup-go@v5
        with:
          go-version: stable
          cache-dependency-path: go.sum
      - run: find . -name go.mod -execdir go mod tidy \;
      - run: go work sync
      - run: git diff --exit-code go.work.sum **/go.mod **/go.sum
      # - run: find . -name go.mod -execdir go test ./... -v \;
      - uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # ratchet:golangci/golangci-lint-action@v8
        with:
          version: latest
  shell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Run the sh-checker
        uses: luizm/action-sh-checker@a3627bbade03e7684152ea3f66d1d350d6cfac14 # ratchet:luizm/action-sh-checker@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHELLCHECK_OPTS: --severity=style
          SHFMT_OPTS: -s
        with:
          sh_checker_comment: true
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: astral-sh/ruff-action@57714a7c8a2e59f32539362ba31877a1957dded1 # ratchet:astral-sh/ruff-action@v3
        with:
          args: "format --check --diff"
      - uses: astral-sh/ruff-action@57714a7c8a2e59f32539362ba31877a1957dded1 # ratchet:astral-sh/ruff-action@v3
      - uses: astral-sh/setup-uv@d9e0f98d3fc6adb07d1e3d37f3043649ddad06a1 # ratchet:astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: Install deps
        run: uv sync --locked --all-extras --dev
      - name: Run type-checking
        run: uvx ty check
      - name: Run tests
        run: uvx pytest
