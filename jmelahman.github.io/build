#!/usr/bin/env bash
set -eo pipefail

shopt -s globstar

DIR="$(cd -- "$(dirname -- "$0")" && pwd)"
SITE_URL="https://jamison.lahman.dev"
BLOG_DIR="blog"

pushd "$DIR" >/dev/null || exit

# Compile HTML
for md in **/*.md; do
	if [ "$(basename "$md")" == "README.md" ]; then
		continue
	fi
	pandoc \
		"$md" \
		-o "${md%.md}.html" \
		--template=template.html \
		--variable=header=true
done

pandoc \
	feed/index.html.body \
	-o feed/index.html \
	--template=template.html \
	--from markdown+raw_html \
	--variable=header=true \
	--variable=script=/scripts/feed.js \
	--variable=title-prefix=Feed \
	--variable=nav_feed=true

# Minify CSS
./css/minify

# Start RSS feed
RSS_PATH="rss.xml"
{
	cat <<EOF
<?xml version="1.0"?>
<rss version="2.0">
<channel>
  <title>jmelahman's blog</title>
  <link>$SITE_URL</link>
  <description>My personal site</description>
  <language>en-us</language>
  <lastBuildDate>$(date -R)</lastBuildDate>
EOF

	for md in "$BLOG_DIR"/*.md; do
		filename=$(basename "$md" .md)
		[ "$filename" = "index" ] && continue

		title=$(sed -n 's/^#\s[ ]*//p' "$md")
		date=$(sed -n 's/^date:[ ]*//p' "$md")
		pubDate=$(date -R -d "$date")

		cat <<EOF
  <item>
    <title>$title</title>
    <link>$SITE_URL/$BLOG_DIR/$filename.html</link>
    <guid>$SITE_URL/$BLOG_DIR/$filename.html</guid>
    <pubDate>$pubDate</pubDate>
  </item>
EOF
	done

	cat <<EOF
</channel>
</rss>
EOF
} >"$RSS_PATH"

popd >/dev/null || exit
